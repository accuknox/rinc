name: SonarQube

on:
  push:
    branches:
      - main
  pull_request:

env:
  AK_URL: "https://cspm.accuknox.com"
  AK_SAST_LABEL: SAST
  SQ_PROJECT_KEY: accuknox_rinc_4a78dfc0-bd4e-43df-81d2-6d9221adf880

jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # shallow clones should be disabled for a better relevancy of analysis

      - uses: accuknox/common-gh-actions/actions/sonarqube@b9cccae8cdc173e027856652025820421a65b0f3
        with:
          host: "https://sq.accuknox.com"
          token: ${{ secrets.SQ_TOKEN }}
          qualityGateCheck: 'false'
          args: >
            -Dsonar.projectKey=${{ env.SQ_PROJECT_KEY }}
            -Dsonar.sources=.
          projectKey: ${{ env.SQ_PROJECT_KEY  }}
          pushToSaas: true
          ak_url: ${{ env.AK_URL }}
          ak_tok: ${{ secrets.AK_PROD_ACCUKNOXTECH_TOKEN }}
          tenant_id: ${{ secrets.AK_PROD_ACCUKNOXTECH_TENANT_ID }}
          label: ${{ env.AK_SAST_LABEL }}
